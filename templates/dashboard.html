<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Job Intelligence Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .stat-card { transition: all 0.3s ease; }
        .stat-card:hover { transform: translateY(-4px); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .nav-link { color: #6b7280; transition: all 0.2s; }
        .nav-link:hover { color: #1f2937; background-color: #f3f4f6; }
        .nav-link.active { color: #3b82f6; background-color: #eff6ff; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm border-b border-gray-200 mb-8">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center space-x-8">
                    <h1 class="text-2xl font-bold text-gray-900">üìä Job Intel</h1>
                    <div class="hidden md:flex items-center space-x-1">
                        <a href="/dashboard" class="nav-link active px-3 py-2 rounded-md text-sm font-medium">Dashboard</a>
                        <a href="/analytics" class="nav-link px-3 py-2 rounded-md text-sm font-medium">Analytics</a>
                        <a href="/companies" class="nav-link px-3 py-2 rounded-md text-sm font-medium">Companies</a>
                        <a href="/jobs" class="nav-link px-3 py-2 rounded-md text-sm font-medium">Jobs</a>
                        <a href="/salary-insights" class="nav-link px-3 py-2 rounded-md text-sm font-medium">Salaries</a>
                        <a href="/submit-seed" class="nav-link px-3 py-2 rounded-md text-sm font-medium">Add Company</a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Hero Header -->
    <div class="gradient-bg shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
            <div class="text-center">
                <h1 class="text-4xl font-bold text-white mb-4">Job Intelligence Platform</h1>
                <p class="text-xl text-white opacity-90 mb-6">Real-time job tracking across top tech companies</p>
                <div class="flex justify-center space-x-4">
                    <div class="bg-white bg-opacity-20 backdrop-blur-lg rounded-lg px-6 py-3 text-white">
                        <div class="text-3xl font-bold" id="total-jobs-hero">-</div>
                        <div class="text-sm opacity-90">Active Jobs</div>
                    </div>
                    <div class="bg-white bg-opacity-20 backdrop-blur-lg rounded-lg px-6 py-3 text-white">
                        <div class="text-3xl font-bold" id="total-companies-hero">-</div>
                        <div class="text-sm opacity-90">Companies</div>
                    </div>
                    <div class="bg-white bg-opacity-20 backdrop-blur-lg rounded-lg px-6 py-3 text-white">
                        <div class="text-3xl font-bold" id="avg-jobs-hero">-</div>
                        <div class="text-sm opacity-90">Avg Jobs/Co</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div id="alert-bar" class="hidden mb-6 rounded-lg p-4"></div>

        <!-- Platform Actions -->
        <div class="mb-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">‚ö° Platform Actions</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="font-semibold text-gray-900 mb-4">üå± Expand Seeds</h3>
                    <div class="space-y-2">
                        <button id="expand-tier1-btn" class="w-full bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition text-sm">
                            Tier 1 (Premium)
                        </button>
                        <button id="expand-tier2-btn" class="w-full bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition text-sm">
                            Tier 2 (Public)
                        </button>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="font-semibold text-gray-900 mb-4">üîç Discovery</h3>
                    <input type="number" id="discovery-limit" value="100" min="10" max="500" 
                        class="w-full border-gray-300 rounded-md shadow-sm mb-2 text-sm">
                    <button id="start-discovery-btn" class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition text-sm">
                        Start Discovery
                    </button>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="font-semibold text-gray-900 mb-4">üîÑ Refresh Jobs</h3>
                    <select id="refresh-hours" class="w-full border-gray-300 rounded-md shadow-sm mb-2 text-sm">
                        <option value="6">6 hours</option>
                        <option value="12">12 hours</option>
                        <option value="24">24 hours</option>
                    </select>
                    <button id="refresh-jobs-btn" class="w-full bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition text-sm">
                        Refresh All
                    </button>
                </div>
            </div>
        </div>

        <!-- Key Statistics -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="stat-card bg-white rounded-lg shadow p-6">
                <p class="text-sm font-medium text-gray-600">Total Jobs</p>
                <p id="stat-total-jobs" class="text-3xl font-bold text-gray-900 mt-2">-</p>
                <p class="text-xs text-gray-500 mt-1">Active positions</p>
            </div>
            <div class="stat-card bg-white rounded-lg shadow p-6">
                <p class="text-sm font-medium text-gray-600">Companies</p>
                <p id="stat-companies" class="text-3xl font-bold text-gray-900 mt-2">-</p>
                <p class="text-xs text-gray-500 mt-1">Actively hiring</p>
            </div>
            <div class="stat-card bg-white rounded-lg shadow p-6">
                <p class="text-sm font-medium text-gray-600">Avg Jobs/Company</p>
                <p id="stat-avg-jobs" class="text-3xl font-bold text-gray-900 mt-2">-</p>
                <p class="text-xs text-gray-500 mt-1">Platform quality</p>
            </div>
            <div class="stat-card bg-white rounded-lg shadow p-6">
                <p class="text-sm font-medium text-gray-600">Seed Companies</p>
                <p id="stat-seeds" class="text-3xl font-bold text-gray-900 mt-2">-</p>
                <p class="text-xs text-gray-500 mt-1">Ready to discover</p>
            </div>
        </div>

        <!-- Work Type Distribution -->
        <div class="bg-white rounded-lg shadow p-6 mb-8">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">üè¢ Work Type Distribution</h2>
            <div class="grid grid-cols-3 gap-4">
                <div class="text-center p-4 bg-blue-50 rounded-lg">
                    <p class="text-2xl font-bold text-blue-900" id="remote-count">-</p>
                    <p class="text-sm text-gray-600">Remote</p>
                    <p class="text-xs text-gray-500" id="remote-percent">-%</p>
                </div>
                <div class="text-center p-4 bg-green-50 rounded-lg">
                    <p class="text-2xl font-bold text-green-900" id="hybrid-count">-</p>
                    <p class="text-sm text-gray-600">Hybrid</p>
                    <p class="text-xs text-gray-500" id="hybrid-percent">-%</p>
                </div>
                <div class="text-center p-4 bg-purple-50 rounded-lg">
                    <p class="text-2xl font-bold text-purple-900" id="onsite-count">-</p>
                    <p class="text-sm text-gray-600">On-site</p>
                    <p class="text-xs text-gray-500" id="onsite-percent">-%</p>
                </div>
            </div>
        </div>

        <!-- API Key -->
        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">üîê API Configuration</h2>
            <div class="flex items-center space-x-4">
                <input type="password" id="api-key-input" placeholder="Enter API key" 
                    class="flex-1 border-gray-300 rounded-md shadow-sm">
                <button id="save-key-btn" class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700">
                    Save Key
                </button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        let API_KEY = localStorage.getItem('api_key') || '';

        if (API_KEY) document.getElementById('api-key-input').value = API_KEY;

        document.getElementById('save-key-btn').addEventListener('click', () => {
            const key = document.getElementById('api-key-input').value.trim();
            if (key) {
                localStorage.setItem('api_key', key);
                API_KEY = key;
                showAlert('API key saved!', 'success');
                loadStats();
            }
        });

        function showAlert(message, type = 'info') {
            const alertBar = document.getElementById('alert-bar');
            const colors = {
                success: 'bg-green-100 text-green-800',
                error: 'bg-red-100 text-red-800',
                info: 'bg-blue-100 text-blue-800'
            };
            alertBar.className = `mb-6 rounded-lg p-4 ${colors[type]}`;
            alertBar.textContent = message;
            alertBar.classList.remove('hidden');
            setTimeout(() => alertBar.classList.add('hidden'), 5000);
        }

        async function apiRequest(endpoint, options = {}) {
            const response = await fetch(`${API_BASE}${endpoint}`, {
                ...options,
                headers: {
                    'Content-Type': 'application/json',
                    'X-API-Key': API_KEY,
                    ...options.headers
                }
            });
            if (!response.ok) throw new Error('Request failed');
            return await response.json();
        }

        async function loadStats() {
            try {
                const data = await apiRequest('/api/stats');
                const totalJobs = data.total_jobs || 0;
                const totalCompanies = data.total_companies || 0;
                const avgJobs = totalCompanies > 0 ? (totalJobs / totalCompanies).toFixed(1) : 0;
                
                document.getElementById('total-jobs-hero').textContent = totalJobs.toLocaleString();
                document.getElementById('total-companies-hero').textContent = totalCompanies.toLocaleString();
                document.getElementById('avg-jobs-hero').textContent = avgJobs;
                
                document.getElementById('stat-total-jobs').textContent = totalJobs.toLocaleString();
                document.getElementById('stat-companies').textContent = totalCompanies.toLocaleString();
                document.getElementById('stat-avg-jobs').textContent = avgJobs;
                document.getElementById('stat-seeds').textContent = (data.total_seeds || 0).toLocaleString();

                // Work type distribution
                const remote = data.work_type_distribution?.remote || 0;
                const hybrid = data.work_type_distribution?.hybrid || 0;
                const onsite = data.work_type_distribution?.onsite || 0;
                const total = remote + hybrid + onsite || 1;

                document.getElementById('remote-count').textContent = remote.toLocaleString();
                document.getElementById('hybrid-count').textContent = hybrid.toLocaleString();
                document.getElementById('onsite-count').textContent = onsite.toLocaleString();
                
                document.getElementById('remote-percent').textContent = ((remote / total) * 100).toFixed(1) + '%';
                document.getElementById('hybrid-percent').textContent = ((hybrid / total) * 100).toFixed(1) + '%';
                document.getElementById('onsite-percent').textContent = ((onsite / total) * 100).toFixed(1) + '%';
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        }

        document.getElementById('expand-tier1-btn').addEventListener('click', async () => {
            if (!confirm('Expand Tier 1 seeds (premium companies)?')) return;
            try {
                showAlert('üå± Expanding...', 'info');
                const result = await apiRequest('/api/seeds/expand?tier=1', { method: 'POST' });
                showAlert(`‚úÖ Added ${result.added} companies!`, 'success');
                loadStats();
            } catch (error) {
                showAlert('Error: ' + error.message, 'error');
            }
        });

        document.getElementById('expand-tier2-btn').addEventListener('click', async () => {
            if (!confirm('Expand Tier 2 seeds (public companies)?')) return;
            try {
                showAlert('üìä Expanding...', 'info');
                const result = await apiRequest('/api/seeds/expand?tier=2', { method: 'POST' });
                showAlert(`‚úÖ Added ${result.added} companies!`, 'success');
                loadStats();
            } catch (error) {
                showAlert('Error: ' + error.message, 'error');
            }
        });

        document.getElementById('start-discovery-btn').addEventListener('click', async () => {
            const limit = document.getElementById('discovery-limit').value;
            if (!confirm(`Discover up to ${limit} companies?`)) return;
            try {
                showAlert('üîç Starting discovery...', 'info');
                const result = await apiRequest(`/api/collect?max_companies=${limit}`, { method: 'POST' });
                showAlert(`‚úÖ Found ${result.total_jobs_collected} jobs across ${result.total_discovered} companies!`, 'success');
                loadStats();
            } catch (error) {
                showAlert('Error: ' + error.message, 'error');
            }
        });

        document.getElementById('refresh-jobs-btn').addEventListener('click', async () => {
            const hours = document.getElementById('refresh-hours').value;
            if (!confirm(`Refresh companies not updated in ${hours} hours?`)) return;
            try {
                showAlert('üîÑ Refreshing...', 'info');
                const result = await apiRequest(`/api/refresh?hours=${hours}`, { method: 'POST' });
                showAlert(`‚úÖ Refreshed ${result.total_jobs_collected} jobs!`, 'success');
                loadStats();
            } catch (error) {
                showAlert('Error: ' + error.message, 'error');
            }
        });

        if (API_KEY) {
            loadStats();
            setInterval(loadStats, 60000);
        } else {
            showAlert('Please enter API key to get started', 'info');
        }
    </script>
</body>
</html>
