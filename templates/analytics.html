// This is the content for the <script> tag at the end of analytics.html

        const apiUrl = '/api';
        const charts = {};
        let allCompanies = [];
        let allLocations = [];
        let allSources = [];
        
        // --- CHART UTILITIES (Must be defined here or already in your HTML) ---
        
        function getAccent(color) {
            const rootStyle = getComputedStyle(document.documentElement);
            return rootStyle.getPropertyValue(`--accent-${color}`).trim();
        }

        function createLine(id, labels, dataOrDatasets, label, color, isMultiDataset = false) {
            const ctx = document.getElementById(id);
            if (!ctx) return;
            if (charts[id]) charts[id].destroy();
            
            const datasets = isMultiDataset ? dataOrDatasets : [{
                label: label,
                data: dataOrDatasets,
                borderColor: color,
                backgroundColor: color.replace(')', ', 0.2)').replace('rgb(', 'rgba('),
                fill: true,
                tension: 0.4,
                pointRadius: 2
            }];

            charts[id] = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        x: { type: 'time', time: { unit: 'day' }, ticks: { color: '#94a3b8' }, grid: { color: '#334155' } },
                        y: { beginAtZero: false, ticks: { color: '#94a3b8' }, grid: { color: '#334155' } }
                    },
                    plugins: { 
                        legend: { display: isMultiDataset, labels: { color: '#94a3b8' } },
                        tooltip: { mode: 'index', intersect: false }
                    }
                }
            });
        }
        
        function createPie(id, labels, data, colors, type = 'pie') {
            const ctx = document.getElementById(id);
            if (!ctx) return;
            if (charts[id]) charts[id].destroy();

            charts[id] = new Chart(ctx, {
                type: type,
                data: {
                    labels,
                    datasets: [{ data, backgroundColor: colors, hoverOffset: 4, borderWidth: 0 }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            position: 'bottom', 
                            labels: { color: 'var(--text-secondary)' }
                        },
                        tooltip: { enabled: true }
                    },
                    cutout: type === 'doughnut' ? '70%' : '0%',
                }
            });
        }
        
        function createBar(id, labels, datasets) {
            const ctx = document.getElementById(id);
            if (!ctx) return;
            if (charts[id]) charts[id].destroy();
            charts[id] = new Chart(ctx, {
                type: 'bar',
                data: { labels, datasets },
                options: { responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true, ticks: { color: '#94a3b8' }, grid: { color: '#334155' } }, y: { stacked: true, ticks: { color: '#94a3b8' }, grid: { color: '#334155' } } } }
            });
        }

        function createHBar(id, labels, dataOrDatasets, colorOrColors, isMultiDataset = false) {
            const ctx = document.getElementById(id);
            if (!ctx) return;
            if (charts[id]) charts[id].destroy();
            
            const datasets = isMultiDataset ? dataOrDatasets : [{
                data: dataOrDatasets,
                backgroundColor: colorOrColors
            }];

            charts[id] = new Chart(ctx, {
                type: 'bar',
                data: { labels, datasets },
                options: { 
                    indexAxis: 'y', responsive: true, maintainAspectRatio: false, 
                    plugins: { 
                        legend: { display: isMultiDataset, labels: { color: '#94a3b8' } } 
                    }, 
                    scales: { 
                        x: { ticks: { color: '#94a3b8' }, grid: { color: '#334155' } }, 
                        y: { ticks: { color: '#94a3b8' }, grid: { display: false } } 
                    } 
                }
            });
        }

        function fmt(n) {
            if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
            if (n >= 1000) return (n / 1000).toFixed(1) + 'K';
            return (n || 0).toLocaleString();
        }

        function ago(d) {
            if (!d) return '-';
            const s = Math.floor((new Date() - new Date(d)) / 1000);
            if (s < 60) return 'now';
            if (s < 3600) return Math.floor(s / 60) + 'm ago';
            if (s < 86400) return Math.floor(s / 3600) + 'h ago';
            return Math.floor(s / 86400) + 'd ago';
        }
        
        // --- DATA FETCHING & RENDERING CORE FUNCTIONS ---

        async function fetchData(endpoint, params = {}) {
            const url = new URL(`${apiUrl}${endpoint}`, window.location.origin);
            Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));
            const response = await fetch(url);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            return response.json();
        }

        async function loadOverview() {
            try {
                const stats = await fetchData('/stats');
                
                document.getElementById('statusDot').className = 'status-dot' + (stats.is_running ? ' running' : '');
                document.getElementById('statusText').textContent = stats.is_running ? 'Collecting...' : 'Live';

                // Ticker & Stat Cards
                document.getElementById('tickerJobs').textContent = fmt(stats.total_jobs);
                document.getElementById('tickerCompanies').textContent = fmt(stats.total_companies);
                const remotePct = (stats.total_jobs > 0) ? (stats.remote_jobs / stats.total_jobs) * 100 : 0;
                document.getElementById('tickerRemote').textContent = remotePct.toFixed(1) + '%';
                document.getElementById('tickerUpdated').textContent = ago(stats.last_updated);
                
                document.getElementById('statCompanies').textContent = fmt(stats.total_companies);
                document.getElementById('statJobs').textContent = fmt(stats.total_jobs);
                document.getElementById('statRemote').textContent = fmt(stats.remote_jobs);
                document.getElementById('statRemotePercent').textContent = `${remotePct.toFixed(1)}% of total`;
                document.getElementById('statGreenhouse').textContent = fmt(stats.greenhouse_companies);
                document.getElementById('statGHJobs').textContent = fmt(stats.greenhouse_jobs) + ' jobs';
                document.getElementById('statLever').textContent = fmt(stats.lever_companies);
                document.getElementById('statLVJobs').textContent = fmt(stats.lever_jobs) + ' jobs';
                document.getElementById('statSeeds').textContent = fmt(stats.total_seeds);
                document.getElementById('statSeedsTested').textContent = fmt(stats.seeds_tested) + ' tested';

                // Activity & Changes Ticker (fetched via loadActivityFeed)
                await loadActivityFeed();
                
                // Platform Pie Chart
                createPie('platformPie', 
                    ['Greenhouse', 'Lever'], 
                    [stats.greenhouse_companies, stats.lever_companies], 
                    [getAccent('purple'), getAccent('orange')]
                );

                // Work Type Pie Chart
                createPie('workTypePie', 
                    ['Remote', 'Hybrid', 'Onsite'], 
                    [stats.remote_jobs, stats.hybrid_jobs, stats.onsite_jobs], 
                    [getAccent('cyan'), getAccent('orange'), getAccent('blue')]
                );

                // Top Hiring
                renderTopHiring(stats.top_hiring_companies || []); 
                
                // Load initial trend chart
                await loadTrendChart(7, 'overviewChart', false);


            } catch (error) {
                console.error('Error loading overview:', error);
                document.getElementById('statusText').textContent = 'Error';
            }
        }
        
        async function loadTrendChart(days, chartId, isAreaChart = true) {
            try {
                const data = await fetchData('/history', { days });
                const history = data.history.map(item => ({ 
                    t: new Date(item.timestamp), 
                    y: item.total_jobs,
                    remote_jobs: item.remote_jobs,
                    hybrid_jobs: item.hybrid_jobs,
                    onsite_jobs: item.onsite_jobs,
                    greenhouse_jobs: item.greenhouse_jobs,
                    lever_jobs: item.lever_jobs
                }));

                const labels = history.map(d => d.t);
                const totalJobsData = history.map(d => d.y);
                
                if (isAreaChart) {
                    // For Trends page
                    createLine(chartId, labels, totalJobsData, 'Total Jobs', getAccent('cyan'), false);
                } else {
                    // For Overview page (simpler presentation)
                    createLine(chartId, labels, totalJobsData, 'Total Jobs', getAccent('cyan'), false);
                }

                if (chartId === 'trendLine') {
                    // Load the other trend charts too on the trends page
                    createWorkTypeTrendChart(history);
                    createPlatformTrendChart(history);
                    createMonthlyChart(data.monthly_snapshots);
                }

            } catch (error) {
                console.error(`Error loading trend data for ${days} days:`, error);
            }
        }

        async function loadCompaniesPage() {
            // Load all company data once for client-side filtering/sorting
            const tableContainer = document.getElementById('companiesTable').closest('.table-container');
            tableContainer.innerHTML = `<div class="loading"><div class="spinner"></div>Loading Companies...</div>`;
            
            try {
                const data = await fetchData('/companies', { sort_by: 'jobs', limit: 2000 });
                allCompanies = data.companies;
                tableContainer.innerHTML = `
                    <table class="data-table" id="companiesTable">
                        <thead><tr><th>Company</th><th>Platform</th><th>Jobs</th><th>Work Types</th><th>Remote %</th><th>Updated</th></tr></thead>
                        <tbody></tbody>
                    </table>
                `;
                filterCompanies(); // Initial render
            } catch (error) {
                tableContainer.innerHTML = `<div class="empty-state">Failed to load company data.</div>`;
                console.error('Error loading companies:', error);
            }
        }

        function filterCompanies() {
            const search = document.getElementById('companySearch').value.toLowerCase();
            const platform = document.getElementById('platformFilter').value;
            const sortKey = document.getElementById('sortFilter').value;

            let filtered = allCompanies.filter(c => {
                const matchesSearch = c.company_name.toLowerCase().includes(search) || (c.ats_type && c.ats_type.includes(search));
                const matchesPlatform = platform ? c.ats_type === platform : true;
                return matchesSearch && matchesPlatform;
            });
            
            // Sorting logic
            filtered.sort((a, b) => {
                if (sortKey === 'jobs') return b.job_count - a.job_count;
                if (sortKey === 'remote') {
                    const pctA = a.job_count > 0 ? (a.remote_count / a.job_count) : 0;
                    const pctB = b.job_count > 0 ? (b.remote_count / b.job_count) : 0;
                    return pctB - pctA;
                }
                if (sortKey === 'name') return a.company_name.localeCompare(b.company_name);
                return 0;
            });

            renderCompaniesTable(filtered);
        }

        function renderCompaniesTable(companies) {
            const tbody = document.getElementById('companiesTable').querySelector('tbody');
            tbody.innerHTML = ''; // Clear existing rows
            
            if (companies.length === 0) {
                 tbody.innerHTML = '<tr><td colspan="6" class="empty-state"><div class="icon">üîç</div>No companies match your criteria.</td></tr>';
                 return;
            }

            companies.forEach(c => {
                const remotePct = (c.job_count > 0) ? (c.remote_count / c.job_count) * 100 : 0;
                const row = document.createElement('tr');
                // Use default click handler for modal. If the company modal isn't fully implemented, this is a placeholder.
                row.setAttribute('onclick', `showCompanyModal('${c.company_name.replace(/'/g, "\\'")}', '${c.company_id}', '${c.ats_type}')`); 

                row.innerHTML = `
                    <td>${c.company_name}</td>
                    <td><span class="badge ${c.ats_type}">${c.ats_type}</span></td>
                    <td>${fmt(c.job_count)}</td>
                    <td>
                        <div class="work-type-bar" title="Remote: ${fmt(c.remote_count)}, Hybrid: ${fmt(c.hybrid_count)}, Onsite: ${fmt(c.onsite_count)}">
                            <div class="remote" style="width:${(c.remote_count/c.job_count)*100}%;"></div>
                            <div class="hybrid" style="width:${(c.hybrid_count/c.job_count)*100}%;"></div>
                            <div class="onsite" style="width:${(c.onsite_count/c.job_count)*100}%;"></div>
                        </div>
                    </td>
                    <td>${remotePct.toFixed(1)}%</td>
                    <td>${ago(c.last_updated)}</td>
                `;
                tbody.appendChild(row);
            });
        }
        
        async function loadWorkTypePage() {
            // Ensure company data is loaded or refresh if needed
            if (allCompanies.length === 0) {
                 try {
                    const data = await fetchData('/companies', { sort_by: 'jobs', limit: 2000 });
                    allCompanies = data.companies;
                } catch (error) {
                    console.error('Failed to fetch companies for work type analysis:', error);
                    // Continue with zeros if fetch fails
                }
            }

            // Aggregate totals from allCompanies
            const totalJobs = allCompanies.reduce((sum, c) => sum + (c.job_count || 0), 0);
            const remote = allCompanies.reduce((sum, c) => sum + (c.remote_count || 0), 0);
            const hybrid = allCompanies.reduce((sum, c) => sum + (c.hybrid_count || 0), 0);
            const onsite = allCompanies.reduce((sum, c) => sum + (c.onsite_count || 0), 0);

            const remotePct = (totalJobs > 0) ? (remote / totalJobs) * 100 : 0;
            const hybridPct = (totalJobs > 0) ? (hybrid / totalJobs) * 100 : 0;
            const onsitePct = (totalJobs > 0) ? (onsite / totalJobs) * 100 : 0;

            document.getElementById('wtRemote').textContent = fmt(remote);
            document.getElementById('wtRemotePct').textContent = `${remotePct.toFixed(1)}% of total`;
            document.getElementById('wtHybrid').textContent = fmt(hybrid);
            document.getElementById('wtHybridPct').textContent = `${hybridPct.toFixed(1)}% of total`;
            document.getElementById('wtOnsite').textContent = fmt(onsite);
            document.getElementById('wtOnsitePct').textContent = `${onsitePct.toFixed(1)}% of total`;

            // Donut Chart
            createPie('wtDonut', 
                ['Remote', 'Hybrid', 'Onsite'], 
                [remote, hybrid, onsite], 
                [getAccent('cyan'), getAccent('orange'), getAccent('blue')],
                'doughnut'
            );

            // Trend Chart
            await loadWorkTypeTrendChartFromAPI();

            // Remote/Onsite Tables
            renderRemoteOnsiteTables(allCompanies);
        }

        async function loadWorkTypeTrendChartFromAPI() {
            try {
                const data = await fetchData('/history', { days: 7 });
                const history = data.history.map(item => ({ 
                    t: new Date(item.timestamp), 
                    remote_jobs: item.remote_jobs,
                    hybrid_jobs: item.hybrid_jobs,
                    onsite_jobs: item.onsite_jobs
                }));
                
                const labels = history.map(d => d.t);
                const datasets = [
                    { label: 'Remote', data: history.map(d => d.remote_jobs), borderColor: getAccent('cyan'), backgroundColor: 'rgba(6, 182, 212, 0.1)', fill: true, tension: 0.4, pointRadius: 2 },
                    { label: 'Hybrid', data: history.map(d => d.hybrid_jobs), borderColor: getAccent('orange'), backgroundColor: 'rgba(245, 158, 11, 0.1)', fill: true, tension: 0.4, pointRadius: 2 },
                    { label: 'Onsite', data: history.map(d => d.onsite_jobs), borderColor: getAccent('blue'), backgroundColor: 'rgba(59, 130, 246, 0.1)', fill: true, tension: 0.4, pointRadius: 2 }
                ];

                createLine('wtTrend', labels, datasets, null, null, true);
            } catch (error) {
                console.error('Error loading work type trend:', error);
            }
        }
        
        function renderRemoteOnsiteTables(companies) {
            const remoteTableBody = document.getElementById('remoteTable').querySelector('tbody');
            const onsiteTableBody = document.getElementById('onsiteTable').querySelector('tbody');
            remoteTableBody.innerHTML = '';
            onsiteTableBody.innerHTML = '';

            // Filter out companies with 0 jobs and calculate percentages
            let validCompanies = companies.filter(c => c.job_count > 0).map(c => ({
                ...c,
                remotePct: (c.remote_count / c.job_count) * 100,
                onsitePct: (c.onsite_count / c.job_count) * 100
            }));

            // Top Remote (at least 10 jobs)
            const topRemote = validCompanies.filter(c => c.job_count >= 10).sort((a, b) => b.remotePct - a.remotePct).slice(0, 15);
            topRemote.forEach(c => {
                const row = document.createElement('tr');
                row.innerHTML = `<td>${c.company_name}</td><td>${fmt(c.job_count)}</td><td>${fmt(c.remote_count)}</td><td>${c.remotePct.toFixed(1)}%</td>`;
                remoteTableBody.appendChild(row);
            });
            if (topRemote.length === 0) remoteTableBody.innerHTML = '<tr><td colspan="4" class="empty-state">No remote-friendly companies found.</td></tr>';

            // Top Onsite (at least 10 jobs)
            const topOnsite = validCompanies.filter(c => c.job_count >= 10).sort((a, b) => b.onsitePct - a.onsitePct).slice(0, 15);
            topOnsite.forEach(c => {
                const row = document.createElement('tr');
                row.innerHTML = `<td>${c.company_name}</td><td>${fmt(c.job_count)}</td><td>${fmt(c.onsite_count)}</td><td>${c.onsitePct.toFixed(1)}%</td>`;
                onsiteTableBody.appendChild(row);
            });
            if (topOnsite.length === 0) onsiteTableBody.innerHTML = '<tr><td colspan="4" class="empty-state">No onsite-heavy companies found.</td></tr>';
        }

        async function loadChangesPage() {
            try {
                const data = await fetchData('/intel');
                const { surges, declines, expansions } = data;

                document.getElementById('chgSurges').textContent = fmt(surges.length);
                document.getElementById('chgDeclines').textContent = fmt(declines.length);
                document.getElementById('chgExpansions').textContent = fmt(expansions.length);

                renderChangesList('surgesList', surges, 'surge');
                renderChangesList('declinesList', declines, 'decline');
                renderChangesList('expansionsList', expansions, 'expansion');
                
            } catch (error) {
                console.error('Error loading changes data:', error);
            }
        }
        
        async function loadActivityFeed() {
             try {
                const data = await fetchData('/intel');
                const { surges, declines, expansions } = data;
                
                // Combine all events and sort by detected_at (most recent first)
                const activity = [
                    ...surges.map(s => ({ ...s, type: 'surge', detected_at: new Date(s.detected_at) })),
                    ...declines.map(d => ({ ...d, type: 'decline', detected_at: new Date(d.detected_at) })),
                    ...expansions.map(e => ({ ...e, type: 'expansion', detected_at: new Date(e.detected_at) }))
                ].sort((a, b) => b.detected_at - a.detected_at).slice(0, 10); 

                renderChangesList('activityFeed', activity, null, true);
                
                // Update Overview Ticker
                document.getElementById('tickerSurges').textContent = fmt(surges.length);
                document.getElementById('tickerDeclines').textContent = fmt(declines.length);

            } catch (error) {
                console.error('Error loading activity feed:', error);
                document.getElementById('activityFeed').innerHTML = '<div class="empty-state">Failed to load activity.</div>';
            }
        }
        
        function renderChangesList(elementId, items, fixedType, isActivityFeed = false) {
            const container = document.getElementById(elementId);
            container.innerHTML = ''; 

            if (items.length === 0) {
                container.innerHTML = `<div class="empty-state"><div class="icon">${fixedType === 'surge' ? 'üöÄ' : fixedType === 'decline' ? 'üìâ' : fixedType === 'expansion' ? 'üìç' : '‚ú®'}</div>No ${fixedType || 'recent'} changes detected in the last 7 days.</div>`;
                return;
            }

            items.forEach(item => {
                const type = item.type || fixedType;
                const iconMap = { 'surge': 'üöÄ', 'decline': 'üìâ', 'expansion': 'üìç' };
                let title, subtitle;

                if (type === 'expansion') {
                    title = `Expansion to ${item.new_location}`;
                    subtitle = `${item.company_name} (${item.ats_type}). Jobs at detection: ${fmt(item.job_count_at_detection)}`;
                } else if (type === 'surge' || type === 'decline') {
                    const sign = item.change_percent >= 0 ? '+' : '';
                    const percent = Math.abs(item.change_percent * 100);
                    title = `${item.company_name} - ${sign}${Math.round(percent)}% Change`;
                    subtitle = `Jobs: ${fmt(item.previous_count)} ‚Üí ${fmt(item.current_count)}`;
                } else {
                    title = item.company_name;
                    subtitle = `Unknown change type: ${item.type}`;
                }

                const itemHtml = `
                    <div class="activity-item" onclick="showCompanyModal('${item.company_name.replace(/'/g, "\\'")}', '${item.company_id}', '${item.ats_type}')">
                        <div class="activity-icon ${type}">${iconMap[type]}</div>
                        <div class="activity-content">
                            <div class="activity-title">${title}</div>
                            <div class="activity-subtitle">${subtitle}</div>
                        </div>
                        <div class="activity-time">${ago(item.detected_at)}</div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', itemHtml);
            });
        }
        
        async function loadLocationsPage() {
            try {
                const data = await fetchData('/locations-stats');
                allLocations = data.locations;

                // Sort by total companies descending
                allLocations.sort((a, b) => b.total_companies - a.total_companies);

                // Bar Chart (Top 10)
                const topLocations = allLocations.slice(0, 10);
                const labels = topLocations.map(l => l.location);
                const dataPoints = topLocations.map(l => l.total_companies);
                
                createHBar('locationsBar', labels, dataPoints, getAccent('purple'));

                // Table
                renderLocationsTable(allLocations);

            } catch (error) {
                console.error('Error loading locations:', error);
                document.getElementById('locationsTable').querySelector('tbody').innerHTML = '<tr><td colspan="3" class="empty-state">Failed to load locations.</td></tr>';
            }
        }

        function renderLocationsTable(locations) {
            const tbody = document.getElementById('locationsTable').querySelector('tbody');
            tbody.innerHTML = '';
            
            if (locations.length === 0) {
                 tbody.innerHTML = '<tr><td colspan="3" class="empty-state">No location data available.</td></tr>';
                 return;
            }

            const totalCompanies = locations.reduce((sum, l) => sum + l.total_companies, 0);

            locations.forEach(l => {
                const share = (totalCompanies > 0) ? (l.total_companies / totalCompanies) * 100 : 0;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${l.location}</td>
                    <td>${fmt(l.total_companies)}</td>
                    <td>${share.toFixed(1)}%</td>
                `;
                tbody.appendChild(row);
            });
        }
        
        async function loadSourcesPage() {
            try {
                const data = await fetchData('/source-stats');
                allSources = data.sources;

                // Stats Cards
                const totalTested = allSources.reduce((sum, s) => sum + (s.seeds_tested || 0), 0);
                const totalFound = allSources.reduce((sum, s) => sum + (s.companies_found || 0), 0);
                const overallHitRate = (totalTested > 0) ? (totalFound / totalTested) * 100 : 0;
                
                document.getElementById('srcTotal').textContent = fmt(data.total_sources);
                document.getElementById('srcTested').textContent = fmt(totalTested);
                document.getElementById('srcFound').textContent = fmt(totalFound);
                document.getElementById('srcHitRate').textContent = overallHitRate.toFixed(2) + '%';
                
                // Sort by hit rate descending
                allSources.sort((a, b) => b.hit_rate - a.hit_rate);

                // Tier Lists
                const tier1 = allSources.filter(s => s.tier === 1);
                const tier2 = allSources.filter(s => s.tier === 2);
                renderSourceList('tier1List', tier1, 1);
                renderSourceList('tier2List', tier2, 2);

                // Chart
                createSourceChart(allSources);

            } catch (error) {
                console.error('Error loading sources:', error);
                document.getElementById('srcTotal').textContent = 'Error';
            }
        }

        function renderSourceList(elementId, sources, tier) {
            const container = document.getElementById(elementId);
            container.innerHTML = '';
            
            if (sources.length === 0) {
                container.innerHTML = `<div class="empty-state"><div class="icon">üå±</div>No Tier ${tier} sources available.</div>`;
                return;
            }

            sources.forEach(s => {
                const hitRate = (s.hit_rate * 100) || 0;
                const status = s.enabled ? 'Enabled' : 'Disabled';
                const statusColor = s.enabled ? 'var(--accent-green)' : 'var(--accent-red)';

                const itemHtml = `
                    <div class="activity-item" style="cursor:default;">
                        <div class="activity-content" style="padding-left:0;">
                            <div class="activity-title">${s.source} <span class="badge tier${tier}">Tier ${tier}</span></div>
                            <div class="activity-subtitle">${fmt(s.companies_found)} companies found / ${fmt(s.seeds_tested)} tested</div>
                        </div>
                        <div style="text-align:right;flex-shrink:0;">
                            <div class="activity-title" style="color:${getAccent('cyan')};">${hitRate.toFixed(2)}%</div>
                            <div class="activity-subtitle" style="color:${statusColor};">${status}</div>
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', itemHtml);
            });
        }
        
        function createWorkTypeTrendChart(history) {
            // See loadWorkTypeTrendChartFromAPI for implementation (line chart with multiple datasets)
            const labels = history.map(d => d.t);
            const datasets = [
                { label: 'Remote', data: history.map(d => d.remote_jobs), borderColor: getAccent('cyan'), backgroundColor: 'rgba(6, 182, 212, 0.1)', fill: true, tension: 0.4, pointRadius: 2 },
                { label: 'Hybrid', data: history.map(d => d.hybrid_jobs), borderColor: getAccent('orange'), backgroundColor: 'rgba(245, 158, 11, 0.1)', fill: true, tension: 0.4, pointRadius: 2 },
                { label: 'Onsite', data: history.map(d => d.onsite_jobs), borderColor: getAccent('blue'), backgroundColor: 'rgba(59, 130, 246, 0.1)', fill: true, tension: 0.4, pointRadius: 2 }
            ];
            createLine('workTypeTrend', labels, datasets, null, null, true);
        }
        
        function createPlatformTrendChart(history) {
             const labels = history.map(d => d.t);
            const datasets = [
                { label: 'Greenhouse', data: history.map(d => d.greenhouse_jobs), borderColor: getAccent('purple'), backgroundColor: 'rgba(139, 92, 246, 0.1)', fill: true, tension: 0.4, pointRadius: 2 },
                { label: 'Lever', data: history.map(d => d.lever_jobs), borderColor: getAccent('orange'), backgroundColor: 'rgba(245, 158, 11, 0.1)', fill: true, tension: 0.4, pointRadius: 2 }
            ];
            createLine('platformTrend', labels, datasets, null, null, true);
        }
        
        function createMonthlyChart(snapshots) {
            snapshots.sort((a, b) => new Date(a.month) - new Date(b.month));
            
            const labels = snapshots.map(s => new Date(s.month).toLocaleString('en-US', { month: 'short', year: 'numeric' }));
            
            const datasets = [
                {
                    label: 'Total Jobs',
                    data: snapshots.map(s => s.total_jobs),
                    backgroundColor: getAccent('green'),
                    borderRadius: 4
                },
                {
                    label: 'Remote Jobs',
                    data: snapshots.map(s => s.remote_jobs),
                    backgroundColor: getAccent('cyan'),
                    borderRadius: 4
                }
            ];
            createBar('monthlyChart', labels, datasets);
        }

        function createSourceChart(sources) {
            sources.sort((a, b) => b.hit_rate - a.hit_rate);
            
            const labels = sources.map(s => s.source);
            const data = sources.map(s => s.hit_rate * 100);
            const colors = sources.map(s => s.tier === 1 ? getAccent('green') : getAccent('orange'));

            createHBar('sourceChart', labels, data, colors);
        }

        function renderTopHiring(companies) {
             const container = document.getElementById('topHiring');
             container.innerHTML = '';
             
             if (!companies || companies.length === 0) {
                 container.innerHTML = `<div class="empty-state"><div class="icon">üèÜ</div>No top hiring data available.</div>`;
                 return;
             }
             
             companies.forEach(c => {
                 const percent = (c.job_count > 0) ? (c.remote_count / c.job_count) * 100 : 0;
                 const item = `
                     <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 20px;border-bottom:1px solid var(--border-light);cursor:pointer;" 
                          onclick="showCompanyModal('${c.company_name.replace(/'/g, "\\'")}', '${c.company_id}', '${c.ats_type}')">
                         <div>
                             <div style="font-weight:500;">${c.company_name}</div>
                             <div style="font-size:0.8rem;color:var(--text-secondary);">${c.ats_type} - ${c.location || 'N/A'}</div>
                         </div>
                         <div style="text-align:right;">
                             <div style="font-weight:600;color:var(--accent-green);">${fmt(c.job_count)} Jobs</div>
                             <div style="font-size:0.7rem;color:var(--text-muted);">${percent.toFixed(0)}% Remote</div>
                         </div>
                     </div>
                 `;
                 container.insertAdjacentHTML('beforeend', item);
             });
        }
        
        // --- EVENT HANDLERS ---
        
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', async (e) => {
                const pageId = e.target.getAttribute('data-page');
                
                // Switch Tabs and Pages
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                e.target.classList.add('active');
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                document.getElementById(`page-${pageId}`).classList.add('active');

                // Load data for the new page
                // Note: Overview is loaded once on init, but can be re-run for fresh data
                if (pageId === 'overview') { await loadOverview(); } 
                else if (pageId === 'trends') { await loadTrendChart(7, 'trendLine', true); }
                else if (pageId === 'companies') { await loadCompaniesPage(); }
                else if (pageId === 'worktype') { await loadWorkTypePage(); }
                else if (pageId === 'changes') { await loadChangesPage(); }
                else if (pageId === 'locations') { await loadLocationsPage(); }
                else if (pageId === 'sources') { await loadSourcesPage(); }
            });
        });

        document.getElementById('overviewRange').addEventListener('click', async (e) => {
             if (e.target.tagName === 'BUTTON') {
                document.querySelectorAll('#overviewRange button').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                const days = parseInt(e.target.getAttribute('data-days'));
                await loadTrendChart(days, 'overviewChart', false);
             }
        });
        
        document.getElementById('trendsRange').addEventListener('click', async (e) => {
             if (e.target.tagName === 'BUTTON') {
                document.querySelectorAll('#trendsRange button').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                const days = parseInt(e.target.getAttribute('data-days'));
                await loadTrendChart(days, 'trendLine', true);
             }
        });


        // --- MODAL FUNCTIONS ---
        
        function showCompanyModal(name, id, type) {
            document.getElementById('modalTitle').textContent = `${name} (${type})`;
            document.getElementById('modalBody').innerHTML = `
                <p>Company ID: <strong>${id}</strong></p>
                <p>This section would display detailed company information like full job list, location breakdown, and hiring history. The data would typically be loaded from a dedicated <code>/api/jobs?company_id=${id}</code> endpoint.</p>
                <div class="card" style="margin-top:20px;">
                    <div class="card-header"><h3>7-Day Job Trend (Placeholder)</h3></div>
                    <div class="card-body">
                         <div class="chart-container" style="height:200px;"><canvas id="companyTrendChart"></canvas></div>
                    </div>
                </div>
            `;
            document.getElementById('companyModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('companyModal').classList.remove('active');
        }

        // --- INIT ---

        loadOverview(); // Load the default tab on page load
