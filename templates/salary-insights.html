<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Salary Insights - Job Intelligence Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        .chart-container { position: relative; height: 350px; }
        .metric-card { transition: all 0.3s ease; }
        .metric-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .nav-link { color: #6b7280; transition: all 0.2s; }
        .nav-link:hover { color: #1f2937; background-color: #f3f4f6; }
        .nav-link.active { color: #3b82f6; background-color: #eff6ff; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center space-x-8">
                    <h1 class="text-2xl font-bold text-gray-900">üìä Job Intel</h1>
                    <div class="hidden md:flex items-center space-x-1">
                        <a href="/dashboard" class="nav-link px-3 py-2 rounded-md text-sm font-medium">Dashboard</a>
                        <a href="/analytics" class="nav-link px-3 py-2 rounded-md text-sm font-medium">Analytics</a>
                        <a href="/companies" class="nav-link px-3 py-2 rounded-md text-sm font-medium">Companies</a>
                        <a href="/jobs" class="nav-link px-3 py-2 rounded-md text-sm font-medium">Jobs</a>
                        <a href="/salary-insights" class="nav-link active px-3 py-2 rounded-md text-sm font-medium">Salaries</a>
                        <a href="/submit-seed" class="nav-link px-3 py-2 rounded-md text-sm font-medium">Add Company</a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">üí∞ Salary Intelligence</h1>
            <p class="text-gray-600">Comprehensive compensation data across top tech companies</p>
        </div>

        <!-- Alert -->
        <div id="alert-bar" class="hidden mb-6 rounded-lg p-4"></div>

        <!-- Key Metrics -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="metric-card bg-white rounded-lg shadow p-6">
                <p class="text-sm font-medium text-gray-600">Median Salary</p>
                <p id="metric-median" class="text-3xl font-bold text-gray-900 mt-2">-</p>
            </div>
            <div class="metric-card bg-white rounded-lg shadow p-6">
                <p class="text-sm font-medium text-gray-600">Salary Range</p>
                <p id="metric-range" class="text-2xl font-bold text-gray-900 mt-2">-</p>
            </div>
            <div class="metric-card bg-white rounded-lg shadow p-6">
                <p class="text-sm font-medium text-gray-600">Jobs with Salary</p>
                <p id="metric-with-salary" class="text-3xl font-bold text-gray-900 mt-2">-</p>
                <p id="metric-salary-percent" class="text-xs text-gray-500 mt-1">-% of total</p>
            </div>
            <div class="metric-card bg-white rounded-lg shadow p-6">
                <p class="text-sm font-medium text-gray-600">Top Paying Role</p>
                <p id="metric-top-role" class="text-xl font-bold text-gray-900 mt-2">-</p>
                <p id="metric-top-salary" class="text-xs text-gray-500 mt-1">-</p>
            </div>
        </div>

        <!-- Charts Row 1 -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">üíº Average Salary by Role</h3>
                <div class="chart-container">
                    <canvas id="salary-by-role-chart"></canvas>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">üåç Average Salary by Location</h3>
                <div class="chart-container">
                    <canvas id="salary-by-location-chart"></canvas>
                </div>
            </div>
        </div>

        <!-- Charts Row 2 -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">üìä Salary Range Distribution</h3>
                <div class="chart-container">
                    <canvas id="salary-range-chart"></canvas>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">üè¢ Top Paying Companies</h3>
                <div class="chart-container">
                    <canvas id="company-salary-chart"></canvas>
                </div>
            </div>
        </div>

        <!-- Salary Percentiles -->
        <div class="bg-white rounded-lg shadow p-6 mb-8">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">üìà Salary Percentiles</h3>
            <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                <div class="text-center p-4 bg-gray-50 rounded-lg">
                    <p class="text-sm text-gray-600">10th</p>
                    <p id="percentile-10" class="text-2xl font-bold text-gray-900 mt-2">-</p>
                </div>
                <div class="text-center p-4 bg-gray-50 rounded-lg">
                    <p class="text-sm text-gray-600">25th</p>
                    <p id="percentile-25" class="text-2xl font-bold text-gray-900 mt-2">-</p>
                </div>
                <div class="text-center p-4 bg-blue-50 rounded-lg border-2 border-blue-500">
                    <p class="text-sm text-blue-600 font-medium">50th (Median)</p>
                    <p id="percentile-50" class="text-2xl font-bold text-blue-900 mt-2">-</p>
                </div>
                <div class="text-center p-4 bg-gray-50 rounded-lg">
                    <p class="text-sm text-gray-600">75th</p>
                    <p id="percentile-75" class="text-2xl font-bold text-gray-900 mt-2">-</p>
                </div>
                <div class="text-center p-4 bg-gray-50 rounded-lg">
                    <p class="text-sm text-gray-600">90th</p>
                    <p id="percentile-90" class="text-2xl font-bold text-gray-900 mt-2">-</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        const API_KEY = localStorage.getItem('api_key') || '';
        let charts = {};

        function formatCurrency(amount, currency = 'USD') {
            if (!amount) return '-';
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: currency,
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        async function apiRequest(endpoint) {
            const response = await fetch(`${API_BASE}${endpoint}`, {
                headers: { 'X-API-Key': API_KEY }
            });
            if (!response.ok) throw new Error('Request failed');
            return await response.json();
        }

        function showAlert(message, type = 'info') {
            const alertBar = document.getElementById('alert-bar');
            const colors = {
                success: 'bg-green-100 text-green-800',
                error: 'bg-red-100 text-red-800',
                info: 'bg-blue-100 text-blue-800'
            };
            alertBar.className = `mb-6 rounded-lg p-4 ${colors[type]}`;
            alertBar.textContent = message;
            alertBar.classList.remove('hidden');
            setTimeout(() => alertBar.classList.add('hidden'), 5000);
        }

        async function loadSalaryInsights() {
            try {
                const data = await apiRequest('/api/salary-insights');
                updateMetrics(data);
                updateCharts(data);
                updatePercentiles(data);
            } catch (error) {
                showAlert('Failed to load salary insights. Make sure you added the API endpoint to main.py.', 'error');
            }
        }

        function updateMetrics(data) {
            const metrics = data.overview || {};
            document.getElementById('metric-median').textContent = formatCurrency(metrics.median_salary);
            
            if (metrics.min_salary && metrics.max_salary) {
                document.getElementById('metric-range').textContent = 
                    `${formatCurrency(metrics.min_salary)} - ${formatCurrency(metrics.max_salary)}`;
            }
            
            document.getElementById('metric-with-salary').textContent = (metrics.jobs_with_salary || 0).toLocaleString();
            
            if (metrics.total_jobs) {
                const percent = ((metrics.jobs_with_salary / metrics.total_jobs) * 100).toFixed(1);
                document.getElementById('metric-salary-percent').textContent = `${percent}% of total`;
            }
            
            if (data.by_role && data.by_role.length > 0) {
                const topRole = data.by_role[0];
                document.getElementById('metric-top-role').textContent = topRole.role;
                document.getElementById('metric-top-salary').textContent = formatCurrency(topRole.avg_salary);
            }
        }

        function updateCharts(data) {
            if (data.by_role && data.by_role.length > 0) {
                const ctx = document.getElementById('salary-by-role-chart').getContext('2d');
                if (charts.byRole) charts.byRole.destroy();
                const roles = data.by_role.slice(0, 10);
                charts.byRole = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: roles.map(r => r.role),
                        datasets: [{
                            label: 'Average Salary',
                            data: roles.map(r => r.avg_salary),
                            backgroundColor: '#3b82f6'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: {
                                ticks: {
                                    callback: function(value) {
                                        return '$' + (value/1000) + 'k';
                                    }
                                }
                            }
                        }
                    }
                });
            }

            if (data.by_location && data.by_location.length > 0) {
                const ctx = document.getElementById('salary-by-location-chart').getContext('2d');
                if (charts.byLocation) charts.byLocation.destroy();
                const locations = data.by_location.slice(0, 10);
                charts.byLocation = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: locations.map(l => l.location),
                        datasets: [{
                            label: 'Average Salary',
                            data: locations.map(l => l.avg_salary),
                            backgroundColor: '#10b981'
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: {
                                ticks: {
                                    callback: function(value) {
                                        return '$' + (value/1000) + 'k';
                                    }
                                }
                            }
                        }
                    }
                });
            }

            if (data.distribution && data.distribution.length > 0) {
                const ctx = document.getElementById('salary-range-chart').getContext('2d');
                if (charts.distribution) charts.distribution.destroy();
                charts.distribution = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: data.distribution.map(d => d.range),
                        datasets: [{
                            data: data.distribution.map(d => d.count),
                            backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'right' } }
                    }
                });
            }

            if (data.by_company && data.by_company.length > 0) {
                const ctx = document.getElementById('company-salary-chart').getContext('2d');
                if (charts.byCompany) charts.byCompany.destroy();
                const companies = data.by_company.slice(0, 10);
                charts.byCompany = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: companies.map(c => c.company),
                        datasets: [{
                            label: 'Avg Salary',
                            data: companies.map(c => c.avg_salary),
                            backgroundColor: '#8b5cf6'
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: {
                                ticks: {
                                    callback: function(value) {
                                        return '$' + (value/1000) + 'k';
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        function updatePercentiles(data) {
            const percentiles = data.percentiles || {};
            document.getElementById('percentile-10').textContent = formatCurrency(percentiles.p10);
            document.getElementById('percentile-25').textContent = formatCurrency(percentiles.p25);
            document.getElementById('percentile-50').textContent = formatCurrency(percentiles.p50);
            document.getElementById('percentile-75').textContent = formatCurrency(percentiles.p75);
            document.getElementById('percentile-90').textContent = formatCurrency(percentiles.p90);
        }

        if (!API_KEY) {
            window.location.href = '/dashboard';
        } else {
            loadSalaryInsights();
        }
    </script>
</body>
</html>
